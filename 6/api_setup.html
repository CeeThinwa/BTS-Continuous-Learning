
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Building Notes &#8212; BTS: Continuous Learning</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Resource Bin" href="../ref/resources.html" />
    <link rel="prev" title="Database Setup Notes" href="database_setup.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">BTS: Continuous Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Behind the Scenes of my Learning Journey
   <br/>
   ü§îüí°
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../1/pandas_python.html">
   Functional Pandas in Python workflow üêºüêç
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../2/JB_explored.html">
   Jupyter Books explored üìô
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../2/initial_setup.html">
     Initial Setup &amp; Maintenance üõ†Ô∏è
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../2/customised_front_end.html">
     Customizing the Front End üåº
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../3/NLP_explored.html">
   Natural Language Processing explored
   <br/>
   üî†üì¢üà∫
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../3/mental_scaffolding.html">
     Mental Scaffolding
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3/NLP_experiences.html">
     My NLP Experiences
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="cloud_explored.html">
   Cloud explored
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="server_setup.html">
     Server Setup Notes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="database_setup.html">
     Database Setup Notes
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     API Building Notes
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../ref/resources.html">
   Resource Bin
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../ref/code_along_resources.html">
     Code-Along Resources
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ref/career_resources.html">
     Career Resources for Data Professionals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ref/further_reading.html">
     Further reading
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/6/api_setup.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fleshing-out-the-processes-and-tasks">
   Fleshing out the processes and tasks
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fleshing-out-image-fetcher-api">
     Fleshing out
     <code class="docutils literal notranslate">
      <span class="pre">
       Image
      </span>
      <span class="pre">
       Fetcher
      </span>
     </code>
     API
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fleshing-out-text-reader-api">
     Fleshing out
     <code class="docutils literal notranslate">
      <span class="pre">
       Text
      </span>
      <span class="pre">
       Reader
      </span>
     </code>
     API
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploying-the-initial-mvp">
   Deploying the initial MVP
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preparing-the-script-locally-for-production">
     Preparing the script locally for production
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>API Building Notes</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fleshing-out-the-processes-and-tasks">
   Fleshing out the processes and tasks
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fleshing-out-image-fetcher-api">
     Fleshing out
     <code class="docutils literal notranslate">
      <span class="pre">
       Image
      </span>
      <span class="pre">
       Fetcher
      </span>
     </code>
     API
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fleshing-out-text-reader-api">
     Fleshing out
     <code class="docutils literal notranslate">
      <span class="pre">
       Text
      </span>
      <span class="pre">
       Reader
      </span>
     </code>
     API
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploying-the-initial-mvp">
   Deploying the initial MVP
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preparing-the-script-locally-for-production">
     Preparing the script locally for production
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="api-building-notes">
<span id="api-setup"></span><h1>API Building Notes<a class="headerlink" href="#api-building-notes" title="Permalink to this headline">¬∂</a></h1>
<p>When building an API, I found it very helpful for me to:</p>
<ol class="simple">
<li><p>Sketch out the key tasks that I wanted the API(s) to do for me</p></li>
<li><p>Split these key tasks into project phases</p></li>
<li><p>At each phase,</p>
<ul class="simple">
<li><p>Code a sample script to get a feel for the process, troubleshooting any errors along the way</p></li>
<li><p>Use the sample script to update a database of choice locally</p></li>
<li><p>Identify the resources and sub-resources generated by the processes</p></li>
<li><p>Identify the modules, functions and classes resulting from each key process</p></li>
<li><p>Arrange the code under a REST API framework of choice</p></li>
<li><p>Deploy the code in a VPS after <a class="reference internal" href="server_setup.html"><span class="doc std std-doc">server setup</span></a></p></li>
</ul>
</li>
</ol>
<div class="section" id="fleshing-out-the-processes-and-tasks">
<h2>Fleshing out the processes and tasks<a class="headerlink" href="#fleshing-out-the-processes-and-tasks" title="Permalink to this headline">¬∂</a></h2>
<p>The first step having a high-level understanding of the process, which I visualized below:</p>
<p><img alt="High level process" src="../_images/app-flowchart.png" /></p>
<div class="section" id="fleshing-out-image-fetcher-api">
<h3>Fleshing out <code class="docutils literal notranslate"><span class="pre">Image</span> <span class="pre">Fetcher</span></code> API<a class="headerlink" href="#fleshing-out-image-fetcher-api" title="Permalink to this headline">¬∂</a></h3>
<p>I then wrote a sample Python script, leveraging</p>
<ul class="simple">
<li><p>The <a class="reference external" href="https://pygithub.readthedocs.io/en/stable/introduction.html">PyGithub library</a> and</p></li>
<li><p>A token that I had created in Github with limited scope (I could only access the image repository)</p></li>
</ul>
<p>The code is below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">github</span> <span class="kn">import</span> <span class="n">Github</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">stringToRGB</span><span class="p">(</span><span class="n">base64_string</span><span class="p">):</span>
    <span class="n">imgdata</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base64_string</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">imgdata</span><span class="p">))</span>
    <span class="n">opencv_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">img</span><span class="p">,</span><span class="n">opencv_img</span><span class="p">]</span>

<span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;username&#39;</span> <span class="c1"># your Github username</span>
<span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;token&#39;</span>

<span class="c1"># authenticate to github</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
<span class="c1"># get the authenticated user</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
<span class="k">for</span> <span class="n">repo</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get_repos</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="s2">&quot;username/Kenyans_in_Media_NLP_CV_data&quot;</span><span class="p">:</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">content1</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">content2</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;/Dec_2021&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">content3</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">content2</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">content4</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">content3</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/cropped&quot;</span><span class="p">):</span>
                        <span class="n">tree</span><span class="p">[</span><span class="n">content4</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">stringToRGB</span><span class="p">(</span><span class="n">content4</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">60</span><span class="p">:</span>
                            <span class="n">tree</span><span class="p">[</span><span class="n">content4</span><span class="o">.</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</pre></div>
</div>
<p>Having ran the sample script, I noticed a couple of things:</p>
<ol class="simple">
<li><p>I had a really hard time decoding the images because they were represented as <code class="docutils literal notranslate"><span class="pre">base64</span></code> objects in their raw state; luckily, <a class="reference external" href="https://stackoverflow.com/questions/16214190/how-to-convert-base64-string-to-image">this solution</a> helped me get unstuck</p></li>
<li><p>When I ran the script, It ran 60 times before it the error below:<br>
<img alt="1st Image Fetcher error" src="../_images/image-fetcher-error-1.jpg" /><br>
When I dug deeper into the local version of the repo, I realized that the code could only keep going down the tree until it had no more images to dig up, making it throw the error above; data collected was from only 1 newspaper.</p></li>
</ol>
<p>The code above gave me the following ideas around the tasks that I would like <code class="docutils literal notranslate"><span class="pre">Image</span> <span class="pre">Fetcher</span></code> to do and the accompanying tests for each task:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Tasks</p></th>
<th class="head"><p>Tests</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Access GitHub via username and token</p></td>
<td><p>i) Are credentials hidden in the system?<br> ii) Is the username valid?<br> iii) If the username is valid, is the token valid?</p></td>
</tr>
<tr class="row-odd"><td><p>Obtain all possible paths to the cropped images from archive</p></td>
<td><p>i) Can the <code class="docutils literal notranslate"><span class="pre">path</span> <span class="pre">collector</span></code> be able to move up and down the directory tree?<br> ii) Is each collected path matching filesystem on server?<br> iii) Is there any content at each collected path?<br> iv) Is the content at each collected path the expected datatype?</p></td>
</tr>
<tr class="row-even"><td><p>Obtain the image and decrypt it</p></td>
<td><p>i) Is the <code class="docutils literal notranslate"><span class="pre">base64</span></code> encoded string decoded as a valid image file i.e. visualizable?</p></td>
</tr>
<tr class="row-odd"><td><p>Store the image in ElasticSearch database</p></td>
<td><p>i) Is the code output JSONified?</p></td>
</tr>
</tbody>
</table>
<p>My framework of choice for building an app was Flask (<a class="reference external" href="https://realpython.com/api-integration-in-python/">this article</a>
and <a class="reference external" href="https://realpython.com/flask-connexion-rest-api/">this one</a> were really great in easing me into the world of APIs).
This resulted in the following code within the Flask framework (which gave me all the cropped scanned images in the
repository):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">github</span> <span class="kn">import</span> <span class="n">Github</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">load_dotenv</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;C:\Users\CT\Documents\GitHub\KIP\kenyans-in-print\.env&quot;</span><span class="p">)</span>

<span class="c1"># get username and password</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;g_user&quot;</span><span class="p">)</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;g_pwd&quot;</span><span class="p">)</span>
<span class="c1"># authenticate to github</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
<span class="c1"># get the authenticated user</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/images&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">image_fetcher</span><span class="p">():</span>
    <span class="c1"># get image paths</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">repo</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get_repos</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="s2">&quot;CeeThinwa/Kenyans_in_Media_NLP_CV_data&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">content1</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Dec_2021&#39;</span><span class="p">]</span>  <span class="c1"># &#39;Jan_2022&#39;, &#39;Feb_2022&#39;] will uncomment as I crop the images and build the MVP</span>
                <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">content2</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">content3</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">content2</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">content4</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">content3</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/cropped&quot;</span><span class="p">):</span>
                                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content4</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># get images as raw byte strings</span>
    <span class="n">image_tree</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">repo</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get_repos</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="s2">&quot;CeeThinwa/Kenyans_in_Media_NLP_CV_data&quot;</span><span class="p">:</span>
                <span class="n">image_tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="s2">&quot;raw_image&quot;</span><span class="p">:</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
                <span class="p">}</span>

    <span class="k">return</span> <span class="n">image_tree</span>
</pre></div>
</div>
<p>One of the learnings that I got was that binary objects, OpenCV or Pillow objects can‚Äôt be serialized in JSON, so the
images have to maintained as byte strings.</p>
<p>Due to the multiple challenges creating an ElasticSearch database locally (which I cover in more detail <a class="reference internal" href="database_setup.html"><span class="doc std std-doc">here</span></a>),
I decided to focus on testing the code locally by connecting to GitHub to get the data, but not saving any results locally.</p>
</div>
<div class="section" id="fleshing-out-text-reader-api">
<h3>Fleshing out <code class="docutils literal notranslate"><span class="pre">Text</span> <span class="pre">Reader</span></code> API<a class="headerlink" href="#fleshing-out-text-reader-api" title="Permalink to this headline">¬∂</a></h3>
<p>This stage was trickier because AWS has a certain way it‚Äôs resources can be used, making it more
complex than GitHub. The pre-work I had to do from an AWS perspective was:</p>
<ol class="simple">
<li><p>Create a user account in AWS and map it to the root account</p></li>
<li><p>Create a scope to allow the new user full access to Textract</p></li>
<li><p>Create a key as the login method for the child user to use Textract</p></li>
</ol>
<p>Once this was in play, I ran the following sample script that easily analyzed a local test image with great results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">boto3</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;textract&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>


<span class="c1"># Read image</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;part.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">document</span>
    <span class="n">img</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c1"># Call Amazon Textract</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">detect_document_text</span><span class="p">(</span>
    <span class="n">Document</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Bytes&#39;</span><span class="p">:</span> <span class="n">img</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Print detected text</span>
<span class="n">result_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Blocks&quot;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;BlockType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LINE&quot;</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;033[94m&#39;</span> <span class="o">+</span>  <span class="n">item</span><span class="p">[</span><span class="s2">&quot;Text&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;033[0m&#39;</span><span class="p">)</span>
<span class="c1"># https://stackoverflow.com/questions64045020using-textract-for-ocr-locally</span>
        <span class="n">result_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;033[94m&#39;</span> <span class="o">+</span>  <span class="n">item</span><span class="p">[</span><span class="n">Text</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;033[0m&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span><span class="n">result_string</span><span class="p">)</span>
</pre></div>
</div>
<p>To avoid the hassle of encrypting then decrypting the binary images, I decided to make this API</p>
<ol class="simple">
<li><p>Fetch directly from GitHub the image</p></li>
<li><p>When all GitHub images are in memory, I then call the Textract service and get the result.</p></li>
</ol>
<p>The code in the Flask framework thus became:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">github</span> <span class="kn">import</span> <span class="n">Github</span>
<span class="kn">import</span> <span class="nn">boto3</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">load_dotenv</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;C:\Users\CT\Documents\GitHub\KIP\kenyans-in-print\.env&quot;</span><span class="p">)</span>

<span class="c1"># get username and password</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;g_user&quot;</span><span class="p">)</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;g_pwd&quot;</span><span class="p">)</span>
<span class="c1"># authenticate to github</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">Github</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
<span class="c1"># get the authenticated user</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>

<span class="c1"># connect to Amazon Textract</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;textract&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/texts&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">image_to_text</span><span class="p">():</span>
    <span class="c1"># get image paths</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">repo</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get_repos</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="s2">&quot;CeeThinwa/Kenyans_in_Media_NLP_CV_data&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">content1</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Dec_2021&#39;</span><span class="p">]</span>  <span class="c1"># &#39;Jan_2022&#39;, &#39;Feb_2022&#39;] will uncomment as I crop the images and build the MVP</span>
                <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">content2</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">content3</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">content2</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">content4</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">content3</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/cropped&quot;</span><span class="p">):</span>
                                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content4</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># get images as bytes</span>
    <span class="n">text_tree</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">60</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">repo</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">get_repos</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="s2">&quot;CeeThinwa/Kenyans_in_Media_NLP_CV_data&quot;</span><span class="p">:</span>
                <span class="c1"># to get bytes from github as per https://github.com/PyGithub/PyGithub/issues/576, repo.get_contents(</span>
                <span class="c1"># &quot;/&quot; + paths[ i]).decoded_content</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_contents</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">decoded_content</span>

                <span class="c1"># Call Amazon Textract</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">detect_document_text</span><span class="p">(</span>
                    <span class="n">Document</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Bytes&#39;</span><span class="p">:</span> <span class="n">img</span><span class="p">})</span>

                <span class="c1"># get detected text as per https://stackoverflow.com/questions64045020using-textract-for-ocr-locally</span>
                <span class="n">result_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Blocks&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;BlockType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LINE&quot;</span><span class="p">:</span>
                        <span class="n">result_string</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;Text&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

                <span class="c1">#get raw text</span>
                <span class="n">text_tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="s2">&quot;raw_text&quot;</span><span class="p">:</span> <span class="n">result_string</span>
                <span class="p">}</span>

    <span class="k">return</span> <span class="n">text_tree</span>
</pre></div>
</div>
<p>However, when running the app, it ran into the same problem encountered initially - it could only analyse 60 images,
which were taken from articles published on the earliest newspaper as per data in the repository.</p>
</div>
</div>
<div class="section" id="deploying-the-initial-mvp">
<h2>Deploying the initial MVP<a class="headerlink" href="#deploying-the-initial-mvp" title="Permalink to this headline">¬∂</a></h2>
<p>Once I tested the API locally and saw that it gave good enough results:</p>
<p><img alt="Image API" src="../_images/api-results-1.png" /></p>
<p><img alt="Text API" src="../_images/api-results-2.png" /></p>
<p>I then had to deploy it to production.</p>
<div class="section" id="preparing-the-script-locally-for-production">
<h3>Preparing the script locally for production<a class="headerlink" href="#preparing-the-script-locally-for-production" title="Permalink to this headline">¬∂</a></h3>
<p>The first change I made was to ensure the path matched whatever local environment it was in, so I modified the code to
be the following in the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># get contents in the .env file</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">kenyans-in-print</span><span class="se">\\</span><span class="s2">.env&quot;</span>

<span class="n">load_dotenv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
<p>The next change I made to the script was to change the Flask environment variable to be in production:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set environment to production</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;FLASK_ENV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;production&#39;</span>
</pre></div>
</div>
<p>Finally, I generated the <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> file by running the following command in console:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">freeze</span> <span class="o">&gt;</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>I backed up the repo in the cloud and on an external hard disk.</p>
<p>References:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://marketsplash.com/tutorials/flask/how-to-deploy-flask-applications/">https://marketsplash.com/tutorials/flask/how-to-deploy-flask-applications/</a></p></li>
<li><p><a class="reference external" href="https://flask.palletsprojects.com/en/2.3.x/tutorial/deploy/">https://flask.palletsprojects.com/en/2.3.x/tutorial/deploy/</a></p></li>
</ul>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./6"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="database_setup.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Database Setup Notes</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../ref/resources.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Resource Bin</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Cynthia Thinwa<br/>
    
        &copy; Copyright 2022.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>